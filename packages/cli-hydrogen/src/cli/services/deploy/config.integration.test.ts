import {validateProject, fillDeployConfig} from './config.js'
import {gitInit} from '../../prompts/git-init.js'
import {describe, it, expect, vi} from 'vitest'
import {getLatestGitCommit} from '@shopify/cli-kit/node/git'
import {fileExists, inTemporaryDirectory, touchFile} from '@shopify/cli-kit/node/fs'
import {AbortSilentError} from '@shopify/cli-kit/node/error'

const isWin = process.platform === 'win32'

const defaultConfig = {
  deploymentToken: 'abcdefg',
  oxygenAddress: 'https://integration.test',
  healthCheck: true,
  assumeYes: true,
}

vi.mock('../../prompts/git-init.js')

describe('validateProject() & initializeGit()', () => {
  describe('User refuses to initialize new repository', () => {
    it.skipIf(isWin)('silent abort since outside git directory', async () => {
      await inTemporaryDirectory(async (tmpDir) => {
        vi.mocked(gitInit).mockResolvedValue(false)

        await expect(() => validateProject({...defaultConfig, assumeYes: false, path: tmpDir})).rejects.toThrow(
          new AbortSilentError(),
        )
      })
    })
  })
  describe('User accepts to initialize new repository', () => {
    it.skipIf(isWin)(
      'initializes new git repository',
      async () => {
        await inTemporaryDirectory(async (tmpDir) => {
          await touchFile(`${tmpDir}/integration.txt`)

          await validateProject({...defaultConfig, path: tmpDir})

          await expect(fileExists(`${tmpDir}/.gitignore`)).resolves.toBeTruthy()
          await expect(getLatestGitCommit(tmpDir)).resolves.toBeDefined()
        })
      },
      10 * 1000,
    )
  })
})

describe('getDeployConfig()', () => {
  it.skipIf(isWin)(
    'extract basic information from git',
    async () => {
      await inTemporaryDirectory(async (tmpDir) => {
        await validateProject({...defaultConfig, path: tmpDir})

        const config = await fillDeployConfig({...defaultConfig, path: tmpDir})

        expect(config.commitMessage).toBe('Initial commit generated by Hydrogen')
        expect(config.commitRef).toBe(`refs/heads/main`)
        expect(config.deploymentToken).toBe(defaultConfig.deploymentToken)
        expect(config.oxygenAddress).toBe(defaultConfig.oxygenAddress)
        expect(config.healthCheck).toBe(defaultConfig.healthCheck)
        expect(config.path).toBe(tmpDir)
        expect(new Date(config.timestamp).getTime()).toBeLessThan(new Date().getTime())
        // Can't test config.commitAuthor & config.commitSha. The integration test can be run anywhere and
        // these properties would cause flakiness. The commit author could or couldn't be set and there is
        // no clear fallback like for default branch.
      })
    },
    10 * 1000,
  )
})
