var ee=Object.defineProperty;var te=(e,c,g)=>c in e?ee(e,c,{enumerable:!0,configurable:!0,writable:!0,value:g}):e[c]=g;var $=(e,c,g)=>te(e,typeof c!="symbol"?c+"":c,g);function l(e){return e===null?"null":Array.isArray(e)?"array":typeof e}function h(e){return l(e)==="object"}function re(e){return Array.isArray(e)&&e.length>0&&e.every(c=>"message"in c)}function J(e,c){return e.length<124?e:c}const ne="graphql-transport-ws";var f=(e=>(e[e.InternalServerError=4500]="InternalServerError",e[e.InternalClientError=4005]="InternalClientError",e[e.BadRequest=4400]="BadRequest",e[e.BadResponse=4004]="BadResponse",e[e.Unauthorized=4401]="Unauthorized",e[e.Forbidden=4403]="Forbidden",e[e.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",e[e.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",e[e.ConnectionAcknowledgementTimeout=4504]="ConnectionAcknowledgementTimeout",e[e.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",e[e.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests",e))(f||{}),m=(e=>(e.ConnectionInit="connection_init",e.ConnectionAck="connection_ack",e.Ping="ping",e.Pong="pong",e.Subscribe="subscribe",e.Next="next",e.Error="error",e.Complete="complete",e))(m||{});function H(e){if(!h(e))throw new Error(`Message is expected to be an object, but got ${l(e)}`);if(!e.type)throw new Error("Message is missing the 'type' property");if(typeof e.type!="string")throw new Error(`Message is expects the 'type' property to be a string, but got ${l(e.type)}`);switch(e.type){case"connection_init":case"connection_ack":case"ping":case"pong":{if(e.payload!=null&&!h(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${e.payload}"`);break}case"subscribe":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${l(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!h(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${l(e.payload)}`);if(typeof e.payload.query!="string")throw new Error(`"${e.type}" message payload expects the 'query' property to be a string, but got ${l(e.payload.query)}`);if(e.payload.variables!=null&&!h(e.payload.variables))throw new Error(`"${e.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${l(e.payload.variables)}`);if(e.payload.operationName!=null&&l(e.payload.operationName)!=="string")throw new Error(`"${e.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${l(e.payload.operationName)}`);if(e.payload.extensions!=null&&!h(e.payload.extensions))throw new Error(`"${e.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${l(e.payload.extensions)}`);break}case"next":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${l(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!h(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${l(e.payload)}`);break}case"error":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${l(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!re(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(e.payload)}`);break}case"complete":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${l(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);break}default:throw new Error(`Invalid message 'type' property "${e.type}"`)}return e}function oe(e,c){return H(typeof e=="string"?JSON.parse(e,c):e)}function N(e,c){return H(e),JSON.stringify(e,c)}function pe(e){const{url:c,connectionParams:g,lazy:K=!0,onNonLazyError:R=console.error,lazyCloseTimeout:O=0,keepAlive:q=0,disablePong:V,connectionAckWaitTimeout:W=0,retryAttempts:j=5,retryWait:X=async function(s){const t=Math.pow(2,s);await new Promise(o=>setTimeout(o,t*1e3+Math.floor(Math.random()*2700+300)))},shouldRetry:Y=F,on:n,webSocketImpl:M,generateID:Z=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const t=Math.random()*16|0;return(s=="x"?t:t&3|8).toString(16)})},jsonMessageReplacer:B,jsonMessageReviver:C}=e;let x;if(M){if(!se(M))throw new Error("Invalid WebSocket implementation provided");x=M}else typeof WebSocket<"u"?x=WebSocket:typeof global<"u"?x=global.WebSocket||global.MozWebSocket:typeof window<"u"&&(x=window.WebSocket||window.MozWebSocket);if(!x)throw new Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");const E=x,u=(()=>{const r=(()=>{const t={};return{on(o,a){return t[o]=a,()=>{delete t[o]}},emit(o){var a;"id"in o&&((a=t[o.id])==null||a.call(t,o))}}})(),s={connecting:n!=null&&n.connecting?[n.connecting]:[],opened:n!=null&&n.opened?[n.opened]:[],connected:n!=null&&n.connected?[n.connected]:[],ping:n!=null&&n.ping?[n.ping]:[],pong:n!=null&&n.pong?[n.pong]:[],message:n!=null&&n.message?[r.emit,n.message]:[r.emit],closed:n!=null&&n.closed?[n.closed]:[],error:n!=null&&n.error?[n.error]:[]};return{onMessage:r.on,on(t,o){const a=s[t];return a.push(o),()=>{a.splice(a.indexOf(o),1)}},emit(t,...o){for(const a of[...s[t]])a(...o)}}})();function z(r){const s=[u.on("error",t=>{s.forEach(o=>o()),r(t)}),u.on("closed",t=>{s.forEach(o=>o()),r(t)})]}let w,b=0,_,I=!1,P=0,G=!1;async function L(){clearTimeout(_);const[r,s]=await(w??(w=new Promise((a,d)=>(async()=>{if(I){if(await X(P),!b)return w=void 0,d({code:1e3,reason:"All Subscriptions Gone"});P++}u.emit("connecting",I);const i=new E(typeof c=="function"?await c():c,ne);let S,T;function A(){isFinite(q)&&q>0&&(clearTimeout(T),T=setTimeout(()=>{i.readyState===E.OPEN&&(i.send(N({type:m.Ping})),u.emit("ping",!1,void 0))},q))}z(y=>{w=void 0,clearTimeout(S),clearTimeout(T),d(y),y instanceof Q&&(i.close(4499,"Terminated"),i.onerror=null,i.onclose=null)}),i.onerror=y=>u.emit("error",y),i.onclose=y=>u.emit("closed",y),i.onopen=async()=>{try{u.emit("opened",i);const y=typeof g=="function"?await g():g;if(i.readyState!==E.OPEN)return;i.send(N(y?{type:m.ConnectionInit,payload:y}:{type:m.ConnectionInit},B)),isFinite(W)&&W>0&&(S=setTimeout(()=>{i.close(f.ConnectionAcknowledgementTimeout,"Connection acknowledgement timeout")},W)),A()}catch(y){u.emit("error",y),i.close(f.InternalClientError,J(y instanceof Error?y.message:String(y),"Internal client error"))}};let k=!1;i.onmessage=({data:y})=>{try{const p=oe(y,C);if(u.emit("message",p),p.type==="ping"||p.type==="pong"){u.emit(p.type,!0,p.payload),p.type==="pong"?A():V||(i.send(N(p.payload?{type:m.Pong,payload:p.payload}:{type:m.Pong})),u.emit("pong",!1,p.payload));return}if(k)return;if(p.type!==m.ConnectionAck)throw new Error(`First message cannot be of type ${p.type}`);clearTimeout(S),k=!0,u.emit("connected",i,p.payload,I),I=!1,P=0,a([i,new Promise((ae,v)=>z(v))])}catch(p){i.onmessage=null,u.emit("error",p),i.close(f.BadResponse,J(p instanceof Error?p.message:String(p),"Bad response"))}}})())));r.readyState===E.CLOSING&&await s;let t=()=>{};const o=new Promise(a=>t=a);return[r,t,Promise.race([o.then(()=>{if(!b){const a=()=>r.close(1e3,"Normal Closure");isFinite(O)&&O>0?_=setTimeout(()=>{r.readyState===E.OPEN&&a()},O):a()}}),s])]}function U(r){if(F(r)&&(ie(r.code)||[f.InternalServerError,f.InternalClientError,f.BadRequest,f.BadResponse,f.Unauthorized,f.SubprotocolNotAcceptable,f.SubscriberAlreadyExists,f.TooManyInitialisationRequests].includes(r.code)))throw r;if(G)return!1;if(F(r)&&r.code===1e3)return b>0;if(!j||P>=j||!Y(r))throw r;return I=!0}K||(async()=>{for(b++;;)try{const[,,r]=await L();await r}catch(r){try{if(!U(r))return}catch(s){return R==null?void 0:R(s)}}})();function D(r,s){const t=Z(r);let o=!1,a=!1,d=()=>{b--,o=!0};return(async()=>{for(b++;;)try{const[i,S,T]=await L();if(o)return S();const A=u.onMessage(t,k=>{switch(k.type){case m.Next:{s.next(k.payload);return}case m.Error:{a=!0,o=!0,s.error(k.payload),d();return}case m.Complete:{o=!0,d();return}}});i.send(N({id:t,type:m.Subscribe,payload:r},B)),d=()=>{!o&&i.readyState===E.OPEN&&i.send(N({id:t,type:m.Complete},B)),b--,o=!0,S()},await T.finally(A);return}catch(i){if(!U(i))return}})().then(()=>{a||s.complete()}).catch(i=>{s.error(i)}),()=>{o||d()}}return{on:u.on,subscribe:D,iterate(r){const s=[],t={done:!1,error:null,resolve:()=>{}},o=D(r,{next(d){s.push(d),t.resolve()},error(d){t.done=!0,t.error=d,t.resolve()},complete(){t.done=!0,t.resolve()}}),a=(async function*(){for(;;){for(s.length||await new Promise(i=>t.resolve=i);s.length;)yield s.shift();if(t.error)throw t.error;if(t.done)return}})();return a.throw=async d=>(t.done||(t.done=!0,t.error=d,t.resolve()),{done:!0,value:void 0}),a.return=async()=>(o(),{done:!0,value:void 0}),a},async dispose(){if(G=!0,w){const[r]=await w;r.close(1e3,"Normal Closure")}},terminate(){w&&u.emit("closed",new Q)}}}class Q extends Error{constructor(){super(...arguments);$(this,"name","TerminatedCloseEvent");$(this,"message","4499: Terminated");$(this,"code",4499);$(this,"reason","Terminated");$(this,"wasClean",!1)}}function F(e){return h(e)&&"code"in e&&"reason"in e}function ie(e){return[1e3,1001,1006,1005,1012,1013,1014].includes(e)?!1:e>=1e3&&e<=1999}function se(e){return typeof e=="function"&&"constructor"in e&&"CLOSED"in e&&"CLOSING"in e&&"CONNECTING"in e&&"OPEN"in e}export{f as CloseCode,ne as GRAPHQL_TRANSPORT_WS_PROTOCOL,m as MessageType,Q as TerminatedCloseEvent,pe as createClient,oe as parseMessage,N as stringifyMessage,H as validateMessage};
